<!--
 This file is Free Software under the MIT License
 without warranty, see README.md and LICENSES/MIT.txt for details.

 SPDX-License-Identifier: MIT

 SPDX-FileCopyrightText: 2023 German Federal Office for Information Security (BSI) <https://www.bsi.bund.de>
 Software-Engineering: 2023 Intevation GmbH <https://intevation.de
-->
<script lang="ts">
  import Collapsible from "$lib/Collapsible.svelte";
  import { appStore } from "$lib/store";
  import { tick } from "svelte";
  import ProductStatus from "./ProductStatus.svelte";
  import GeneralSection from "./GeneralSection.svelte";
  import Acknowledgements from "../../acknowledgements/Acknowledgements.svelte";
  import ID from "./ID.svelte";
  import Notes from "$lib/singleview/notes/Notes.svelte";
  import Remediations from "./remediations/Remediations.svelte";
  import Flags from "./flags/Flags.svelte";
  import Involvements from "./involvements/Involvements.svelte";
  import References from "../../references/References.svelte";
  import Threats from "./threats/Threats.svelte";
  import Scores from "./scores/Scores.svelte";

  export let vulnerability: any;
  export let index = 1;
  async function updateUI() {
    await tick();
    document.getElementById(`${vulnerability.cve}`)?.scrollIntoView({ behavior: "smooth" });
  }
  let header = vulnerability.cve ? vulnerability.cve : `Vulnerability ${index}`;
  let open = false;
  $: if ($appStore.ui.selectedCVE === vulnerability.cve) {
    open = true;
    updateUI();
  } else {
    open = false;
  }
</script>

<div>
  <Collapsible
    {header}
    class_="text-primary"
    level="3"
    {open}
    onClose={() => {
      appStore.resetSelectedCVE();
    }}
  >
    <div>
      <GeneralSection {vulnerability} />
      {#if vulnerability.acknowledgments}
        <Collapsible header="Acknowledgements" level="4">
          <Acknowledgements acknowledegments={vulnerability.acknowledgements} />
        </Collapsible>
      {/if}
      {#if vulnerability.flags}
        <Flags {vulnerability} />
      {/if}
      {#if vulnerability.ids && Array.isArray(vulnerability.ids)}
        <ID {vulnerability} />
      {/if}
      {#if vulnerability.involvements}
        <Involvements {vulnerability} />
      {/if}
      {#if vulnerability.notes && Array.isArray(vulnerability.notes)}
        <Collapsible header="Notes" level="4">
          <Notes notes={vulnerability.notes} />
        </Collapsible>
      {/if}
      {#if vulnerability.product_status}
        <ProductStatus {vulnerability} />
      {/if}
      {#if vulnerability.references}
        <Collapsible header="References" level="4">
          <References references={vulnerability.references} />
        </Collapsible>
      {/if}
      {#if vulnerability.remediations}
        <Remediations {vulnerability} />
      {/if}
      {#if vulnerability.scores}
        <Scores {vulnerability} />
      {/if}
      {#if vulnerability.threats}
        <Threats {vulnerability} />
      {/if}
    </div>
  </Collapsible>
</div>
