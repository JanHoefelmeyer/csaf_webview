<script lang="ts">
  import Collapsible from "$lib/Collapsible.svelte";
  import { appStore } from "$lib/store";
  import { tick } from "svelte";

  export let vulnerability: any;
  export let index: number = 1;
  let header = vulnerability.cve ? vulnerability.cve : `Vulnerability ${index}`;
  let open = false;
  $: if ($appStore.ui.selectedCVE === vulnerability.cve) {
    open = true;
    async function updateUI() {
      await tick();
      document.querySelector(`#${vulnerability.cve}`)?.scrollIntoView({ behavior: "smooth" });
    }
    updateUI();
  } else {
    open = false;
  }
</script>

<div>
  <Collapsible
    {header}
    class_="text-primary"
    level="3"
    {open}
    onClose={() => {
      appStore.resetSelectedCVE();
    }}
  >
    <div>
      <dl>
        {#if vulnerability.title}
          <dt>Title</dt>
          <dd>{vulnerability.title}</dd>
        {/if}
        {#if vulnerability.cwe}
          <dt>CWE ID</dt>
          <dd>{vulnerability.cwe.id}</dd>
          <dt>CWE Name</dt>
          <dd>{vulnerability.cwe.name}</dd>
        {/if}
        {#if vulnerability.discovery_date}
          <dt>Discovery date</dt>
          <dd>{vulnerability.discovery_date}</dd>
        {/if}
        {#if vulnerability.release_date}
          <dt>Release date</dt>
          <dd>{vulnerability.release_date}</dd>
        {/if}
      </dl>
      {#if vulnerability.ids && Array.isArray(vulnerability.ids)}
        <Collapsible header="IDs" level="4">
          {#each vulnerability.ids as vulnerabilityID}
            <dl>
              <dt>Systemname</dt>
              <dd>{vulnerabilityID.system_name}</dd>
              <dt>Text</dt>
              <dd>{vulnerabilityID.text}</dd>
            </dl>
          {/each}
        </Collapsible>
      {/if}
      {#if vulnerability.notes && Array.isArray(vulnerability.notes)}
        <Collapsible header="Notes" level="4">
          {#each vulnerability.notes as note}
            <dl>
              <dt>Title</dt>
              <dd>{note.title}</dd>
              <dt>Category</dt>
              <dd>{note.category}</dd>
              <dt>Text</dt>
              <dd>{note.text}</dd>
            </dl>
          {/each}
        </Collapsible>
      {/if}
    </div>
  </Collapsible>
</div>

<style>
  dt {
    font-size: large;
    float: left;
    clear: left;
    width: 15%;
  }
  dd {
    margin-bottom: 0.3em;
  }
</style>
