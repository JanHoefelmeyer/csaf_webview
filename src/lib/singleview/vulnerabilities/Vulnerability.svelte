<!--
 This file is Free Software under the MIT License
 without warranty, see README.md and LICENSES/MIT.txt for details.

 SPDX-License-Identifier: MIT

 SPDX-FileCopyrightText: 2023 German Federal Office for Information Security (BSI) <https://www.bsi.bund.de>
 Software-Engineering: 2023 Intevation GmbH <https://intevation.de
-->
<script lang="ts">
  import Collapsible from "$lib/Collapsible.svelte";
  import { appStore } from "$lib/store";
  import { tick } from "svelte";
  import ProductStatus from "./ProductStatus.svelte";

  export let vulnerability: any;
  export let index = 1;
  async function updateUI() {
    await tick();
    document.querySelector(`#${vulnerability.cve}`)?.scrollIntoView({ behavior: "smooth" });
  }
  let header = vulnerability.cve ? vulnerability.cve : `Vulnerability ${index}`;
  let open = false;
  $: if ($appStore.ui.selectedCVE === vulnerability.cve) {
    open = true;
    updateUI();
  } else {
    open = false;
  }
</script>

<div>
  <Collapsible
    {header}
    class_="text-primary"
    level="3"
    {open}
    onClose={() => {
      appStore.resetSelectedCVE();
    }}
  >
    <div>
      <dl>
        {#if vulnerability.title}
          <dt>Title</dt>
          <dd>{vulnerability.title}</dd>
        {/if}
        {#if vulnerability.cwe}
          <dt>CWE ID</dt>
          <dd>{vulnerability.cwe.id}</dd>
          <dt>CWE Name</dt>
          <dd>{vulnerability.cwe.name}</dd>
        {/if}
        {#if vulnerability.discovery_date}
          <dt>Discovery date</dt>
          <dd>{vulnerability.discovery_date}</dd>
        {/if}
        {#if vulnerability.release_date}
          <dt>Release date</dt>
          <dd>{vulnerability.release_date}</dd>
        {/if}
      </dl>
      {#if vulnerability.ids && Array.isArray(vulnerability.ids)}
        <Collapsible header="IDs" level="4">
          {#each vulnerability.ids as vulnerabilityID}
            <dl>
              <dt>Systemname</dt>
              <dd>{vulnerabilityID.system_name}</dd>
              <dt>Text</dt>
              <dd>{vulnerabilityID.text}</dd>
            </dl>
          {/each}
        </Collapsible>
      {/if}
      {#if vulnerability.notes && Array.isArray(vulnerability.notes)}
        <Collapsible header="Notes" level="4">
          {#each vulnerability.notes as note}
            <div class="note">
              <h6>{note.title}</h6>
              <p>{note.text}</p>
            </div>
          {/each}
        </Collapsible>
      {/if}
      {#if vulnerability.product_status}
        <Collapsible header="Product status" level="4">
          <ProductStatus {vulnerability} />
        </Collapsible>
      {/if}
      {#if vulnerability.acknowledgements}
        <Collapsible header="Acknowledgements" level="4">
          {#each vulnerability.acknowledgements as ack}
            {#if ack.names}
              <h6>- Names</h6>
              <ul>
                {#each ack.names as name}
                  <li>{name}</li>
                {/each}
              </ul>
            {/if}
            {#if ack.organization}
              <h6>Orgnaization</h6>
            {/if}
            {#if ack.summary}
              <div class="note">
                <h6>Summary</h6>
                <p>{ack.summary}</p>
              </div>
            {/if}
            {#if ack.urls}
              <h6>- URLs</h6>
              <ul>
                {#each ack.urls as url}
                  <li>{url}</li>
                {/each}
              </ul>
            {/if}
          {/each}
        </Collapsible>
      {/if}
    </div>
  </Collapsible>
</div>

<style>
  .note {
    text-align: justify;
  }
  dt {
    float: left;
    clear: left;
    font-weight: 100;
    width: 14rem;
  }
  dd {
    margin-bottom: 0.1em;
  }
  h6 {
    font-family: monospace;
    margin-bottom: 0.1em;
  }
  p {
    font-size: small;
    font-family: monospace;
  }
  ul {
    list-style-type: none;
  }
</style>
